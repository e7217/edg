# Telegraf Configuration for EDG IoT Platform
# Receives validated data from EDG Core and forwards to VictoriaMetrics

[agent]
  interval = "100ms"
  flush_interval = "1s"
  hostname = ""
  omit_hostname = false

# NATS Consumer - receive validated data from EDG Core
[[inputs.nats_consumer]]
  servers = ["nats://${NATS_SERVER:-localhost}:${NATS_PORT:-4222}"]
  subjects = ["platform.data.validated"]
  queue_group = "telegraf"
  data_format = "json_v2"

  # Parse nested JSON structure
  [[inputs.nats_consumer.json_v2]]
    [[inputs.nats_consumer.json_v2.tag]]
      path = "asset_id"

    [[inputs.nats_consumer.json_v2.object]]
      path = "values"
      included_keys = ["name", "number", "unit", "quality"]
      tags = ["name", "unit", "quality"]

# VictoriaMetrics output (InfluxDB v2 compatible)
[[outputs.influxdb_v2]]
  urls = ["http://${VM_HOST:-localhost}:${VM_PORT:-8428}"]
  token = ""
  organization = "edg"
  bucket = "sensors"

  # Timeout settings
  timeout = "5s"
