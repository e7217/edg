name: Deploy to Dev Server (Docker)

on:
  push:
    branches: [main, fix/*]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: service  # Self-hosted runner with 'service' tag
    container:
      image: docker:24-cli
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - /srv/actions-runner/_work:/srv/actions-runner/_work

    steps:
      - uses: actions/checkout@v4

      - name: Print path information
        run: |
          echo "=== Path Information ==="
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "PWD: $(pwd)"
          echo "Repository: ${{ github.repository }}"
          echo "Checking if /srv/actions-runner/_work/edg/edg exists:"
          ls -la /srv/actions-runner/_work/edg/ 2>&1 || echo "Path not accessible"

      - name: Set version
        id: version
        run: |
          VERSION=${GITHUB_SHA::7}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Docker images
        run: |
          # Build EDG Core
          docker build \
            --build-arg VERSION=${{ steps.version.outputs.VERSION }} \
            -f deploy/docker/Dockerfile.core \
            -t edg-core:${{ steps.version.outputs.VERSION }} \
            -t edg-core:latest \
            .

          # Build Telegraf
          docker build \
            -f deploy/docker/Dockerfile.telegraf \
            -t edg-telegraf:${{ steps.version.outputs.VERSION }} \
            -t edg-telegraf:latest \
            .

          # Build VictoriaMetrics
          docker build \
            -f deploy/docker/Dockerfile.victoriametrics \
            -t edg-victoriametrics:${{ steps.version.outputs.VERSION }} \
            -t edg-victoriametrics:latest \
            .

      - name: Deploy with Docker Compose
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          GRAFANA_PROVISIONING_PATH: /srv/actions-runner/_work/edg/edg/deploy/configs/grafana/provisioning
        run: |
          cd deploy/docker

          # Debug: Print environment variables
          echo "VERSION=$VERSION"
          echo "GRAFANA_PROVISIONING_PATH=$GRAFANA_PROVISIONING_PATH"

          # Export variables for docker compose
          export VERSION
          export GRAFANA_PROVISIONING_PATH

          # Debug: Check what docker compose will use
          echo "=== Docker Compose Config ==="
          docker compose config | grep -A 5 "edg-grafana:" | grep -A 3 "volumes:"

          # Stop existing containers
          docker compose down || true

          # Start services
          docker compose up -d

          # Wait for services to be ready
          echo "Waiting for services to start..."
          sleep 10

      - name: Health check
        run: |
          cd deploy/docker

          echo "Checking service health..."
          docker compose ps

          # Check edg-core health (NATS monitoring endpoint)
          docker exec edg-core curl -f http://localhost:8222/healthz || {
            echo "Health check failed!"
            docker compose logs edg-core
            exit 1
          }

          echo "✅ Deployment successful!"

      - name: Verify Grafana provisioning
        run: |
          echo "=== Verifying Grafana Provisioning ==="

          echo "1. Check provisioning files on host (from container):"
          ls -la /srv/actions-runner/_work/edg/edg/deploy/configs/grafana/provisioning/

          echo ""
          echo "2. Check Grafana container mounts:"
          docker inspect edg-grafana --format='{{range .Mounts}}Source: {{.Source}} -> Dest: {{.Destination}}{{"\n"}}{{end}}'

          echo ""
          echo "3. Check files inside Grafana container:"
          docker exec edg-grafana ls -la /etc/grafana/provisioning/

          echo ""
          echo "4. Check datasources inside container:"
          docker exec edg-grafana ls -la /etc/grafana/provisioning/datasources/

          echo ""
          echo "5. Check dashboards inside container:"
          docker exec edg-grafana ls -la /etc/grafana/provisioning/dashboards/

          echo ""
          echo "✅ Grafana provisioning verification complete!"

      - name: Show logs
        if: always()
        run: |
          cd deploy/docker

          echo "=== EDG Core Logs ==="
          docker compose logs --tail=50 edg-core

          echo "=== VictoriaMetrics Logs ==="
          docker compose logs --tail=20 edg-victoriametrics

          echo "=== Telegraf Logs ==="
          docker compose logs --tail=20 edg-telegraf

          echo "=== Grafana Logs ==="
          docker compose logs --tail=30 edg-grafana

      - name: Cleanup old images
        if: success()
        run: |
          # Keep only last 3 versions of edg-core
          docker images edg-core --format "{{.ID}} {{.Tag}}" | \
            grep -v latest | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true

          # Keep only last 3 versions of edg-telegraf
          docker images edg-telegraf --format "{{.ID}} {{.Tag}}" | \
            grep -v latest | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true

          # Keep only last 3 versions of edg-victoriametrics
          docker images edg-victoriametrics --format "{{.ID}} {{.Tag}}" | \
            grep -v latest | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true
