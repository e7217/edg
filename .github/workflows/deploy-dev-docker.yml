name: Deploy to Dev Server (Docker)

on:
  push:
    branches: [main, feat/*]
  workflow_dispatch:

jobs:
  deploy:
    # runs-on: self-hosted  # Self-hosted runner with 'service' tag
    runs-on: service  # Self-hosted runner with 'service' tag
    container:
      image: docker:24-cli
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
    steps:
      - uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          VERSION=${GITHUB_SHA::7}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Docker images
        run: |
          # Build EDG Core
          docker build \
            --build-arg VERSION=${{ steps.version.outputs.VERSION }} \
            -t edg-core:${{ steps.version.outputs.VERSION }} \
            -t edg-core:latest \
            .

          # Build Telegraf
          docker build \
            -f Dockerfile.telegraf \
            -t edg-telegraf:${{ steps.version.outputs.VERSION }} \
            -t edg-telegraf:latest \
            .

      - name: Deploy with Docker Compose
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Stop existing containers
          docker compose down || true

          # Start services
          docker compose up -d

          # Wait for services to be ready
          echo "Waiting for services to start..."
          sleep 10

      - name: Health check
        run: |
          echo "Checking service health..."
          docker compose ps

          # Check edg-core health (NATS monitoring endpoint)
          curl -f http://localhost:8222/healthz || {
            echo "Health check failed!"
            docker compose logs edg-core
            exit 1
          }

          echo "âœ… Deployment successful!"

      - name: Show logs
        if: always()
        run: |
          echo "=== EDG Core Logs ==="
          docker compose logs --tail=50 edg-core

          echo "=== VictoriaMetrics Logs ==="
          docker compose logs --tail=20 edg-victoriametrics

          echo "=== Telegraf Logs ==="
          docker compose logs --tail=20 edg-telegraf

      - name: Cleanup old images
        if: success()
        run: |
          # Keep only last 3 versions of edg-core
          docker images edg-core --format "{{.ID}} {{.Tag}}" | \
            grep -v latest | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true

          # Keep only last 3 versions of edg-telegraf
          docker images edg-telegraf --format "{{.ID}} {{.Tag}}" | \
            grep -v latest | \
            tail -n +4 | \
            awk '{print $1}' | \
            xargs -r docker rmi || true
