name: Deploy to Dev Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
      - run: go test ./... -v -race

  deploy:
    needs: test
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'

      - name: Build
        run: go build -ldflags="-s -w" -o edg-core ./cmd/core

      - name: Setup WireGuard
        run: |
          echo "${{ secrets.WIREGUARD_CONFIG }}" > wg0.conf
          chmod 600 wg0.conf
          sudo apt-get update && sudo apt-get install -y wireguard
          sudo wg-quick up ./wg0.conf
          ping -c 2 ${{ env.DEPLOY_HOST }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy
        run: |
          # Upload binary
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            edg-core ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }}:~/

          # Deploy and restart
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
            sudo systemctl stop edg-core || true
            sudo cp ~/edg-core /opt/edg/bin/
            sudo systemctl start edg-core
            rm ~/edg-core
          ENDSSH

      - name: Cleanup
        if: always()
        run: sudo wg-quick down wg0 || true
